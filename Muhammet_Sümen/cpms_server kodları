import asyncio
import logging
from ocpp.v16 import call_result, ChargePoint as cp
from ocpp.v16.enums import Action
from ocpp.routing import on
from websockets.server import serve

logging.basicConfig(level=logging.INFO)

# 1. HEDEFLENEN SUNUCU SINIFI
# Bu sınıf, tüm OCPP mesajlarını işler
class ChargePointManagementSystem(cp):
    
    # Kütüphanenin beklediği ZORUNLU İKİ PARAMETRE
    def __init__(self, charge_point_id, connection):
        super().__init__(charge_point_id, connection)
        logging.info(f"Yeni bağlantı kabul edildi: {charge_point_id}")

    @on(Action.boot_notification)
    def on_boot_notification(self, charge_point_model, charge_point_vendor, **kwargs):
        logging.info(f"CP {self.id} -> Sunucu: BootNotification alındı.")
        return call_result.BootNotification(
            current_time='2025-11-11T14:30:00.000Z',
            interval=300, 
            status='Accepted'
        )

    @on(Action.authorize) 
    def on_authorize(self, id_tag):
        logging.info(f"CP {self.id} -> Sunucu: Authorize alındı.")
        return call_result.Authorize(id_tag_info={'status': 'Accepted'})

    @on(Action.start_transaction) 
    def on_start_transaction(self, connector_id, id_tag, meter_start, timestamp, **kwargs):
        logging.info(f"CP {self.id} -> Sunucu: Şarj Başladı. Meter Başlangıç: {meter_start}")
        return call_result.StartTransaction(
            transaction_id=101, 
            id_tag_info={'status': 'Accepted'}
        )

    @on(Action.stop_transaction)
    def on_stop_transaction(self, transaction_id, meter_stop, timestamp, **kwargs):
        logging.critical(f"CP {self.id} -> Sunucu: STOP ALINDI. Meter Bitiş: {meter_stop} kWh.")
        logging.critical("OCPP sunucusu, CP'den gelen düşük BİTİŞ değerini KABUL ETMEK ZORUNDA KALDI.")
        return call_result.StopTransaction(
            id_tag_info={'status': 'Accepted'}
        )

# 2. BAĞLANTI YÖNETİCİSİ (Hata veren yer burasıydı)
# Bu fonksiyon, her yeni bağlantıyı alır ve Sınıfı (CPMS) başlatır
async def on_connect(websocket, path):
    try:
        # URL'den gelen yolu ID olarak kullan (Örn: /CP_Lab1)
        charge_point_id = path.strip('/')
        
        # Sınıfı, gerekli parametrelerle burada başlat
        cp_instance = ChargePointManagementSystem(charge_point_id, websocket)
        
        # Sınıfın ana döngüsünü (mesaj dinleme) başlat
        await cp_instance.start()

    except Exception as e:
        logging.error(f"Bağlantı hatası: {e}")

# 3. SUNUCU BAŞLATMA
async def main():
    server = await serve(
        on_connect, # Sınıfı değil, bağlantı yöneticisini geçir
        '127.0.0.1', 
        8080,      
        subprotocols=['ocpp1.6']
    )
    logging.info("CPMS Sunucusu 127.0.0.1:8080 adresinde başlatıldı...")
    await server.wait_closed()

if __name__ == '__main__':
    asyncio.run(main())
